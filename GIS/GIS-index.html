<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>فلترة + خريطة</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lama+Sans:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Lama Sans', sans-serif; margin: 0; padding: 20px; background-color: #f9f9f9; }
    .filter-container { position: absolute; top: 20px; right: 20px; z-index: 200; }
    .filter-icon { font-size: 24px; cursor: pointer; margin-bottom: 10px; }
    .filter-form {
      background-color: #fff; padding: 15px; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); max-width: 300px;
    }
    .filter-form label { display: block; margin-top: 10px; font-weight: bold; }
    .filter-form select, .filter-form input {
      width: 100%; padding: 6px; margin-top: 5px;
    }
    .filter-form button {
      margin-top: 15px; padding: 8px; width: 100%;
      background-color: #4CAF50; color: white;
      border: none; border-radius: 4px; cursor: pointer;
    }
    .hidden { display: none; }
    #map {
      width: 100%; min-height: 600px;
      background-color: #ffffff; position: relative;
      transition: filter 0.3s ease;
    }
    .blur-map { filter: blur(4px); }

    .map-tooltip {
      position: absolute; background-color: #fff;
      padding: 6px 12px; border: 1px solid #ccc;
      border-radius: 5px; font-size: 14px;
      color: #000; font-weight: bold; pointer-events: none;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .region-label {
      font-size: 12px; fill: #fff; pointer-events: none;
      font-weight: bold; stroke: #000; stroke-width: 0.8;
    }
    #alertBox {
      position: absolute; top: 20%; right: 50%;
      transform: translate(50%, -20%);
      background: white; padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 300; display: none; text-align: center;
    }
    #alertBox button {
      margin: 10px 5px 0; padding: 5px 12px;
      border: none; border-radius: 5px;
      background-color: #4CAF50; color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="filter-container">
    <i id="toggleFilter" class="fas fa-sliders filter-icon"></i>
    <form class="filter-form hidden">
      <label for="poet">اسم الشاعر</label>
      <select id="poet"><option value="">اختر</option></select>
      <label for="place">اسم المكان</label>
      <select id="place"><option value="">اختر</option></select>
      <label for="type">نوع الشعر</label>
      <select id="type"><option value="">اختر</option></select>
      <label for="purpose">الغرض الشعري</label>
      <select id="purpose"><option value="">اختر</option></select>
      <button type="submit">بحث</button>
    </form>
  </div>

  <div id="map"></div>

  <div id="alertBox">
    <p>ليس هناك نتائج مطابقة.</p>
    <button onclick="restoreAllPins()">إظهار كل المواقع</button>
    <button onclick="resetFilters()">إعادة تعيين البحث</button>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://uuiyhcacxtbhffpwljix.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1aXloY2FjeHRiaGZmcHdsaml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExOTYyNjYsImV4cCI6MjA2Njc3MjI2Nn0.N1iXFjDfeXTLUsY51puvnHC-M-T2erCaQ1OTkXnT6uY'
    );

    let svg, projection, tooltip, allPins = [];

    document.getElementById("toggleFilter").onclick = () => {
      const filterForm = document.querySelector(".filter-form");
      const map = document.getElementById("map");
      const isHidden = filterForm.classList.contains("hidden");

      filterForm.classList.toggle("hidden");
      if (isHidden) map.classList.add("blur-map");
      else map.classList.remove("blur-map");
    };

    async function fetchPoetsAndTypes() {
      const poet = await supabase.from('الشاعر').select('اسم_الشاعر');
      const place = await supabase.from('المكان').select('اسم_المكان');
      const poems = await supabase.from('القصيدة').select('نوع_الشعر, الغرض_الشعري');
      const fillSelect = (id, items) => {
        const el = document.getElementById(id);
        [...new Set(items.filter(Boolean))].forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          el.appendChild(opt);
        });
      };
      fillSelect('poet', poet.data?.map(p => p.اسم_الشاعر) || []);
      fillSelect('place', place.data?.map(p => p.اسم_المكان) || []);
      fillSelect('type', poems.data?.map(p => p.نوع_الشعر) || []);
      fillSelect('purpose', poems.data?.map(p => p.الغرض_الشعري) || []);
    }

    function getSaudiColors() {
      return {
        "منطقة الرياض": "#1A6566", "منطقة مكة المكرمة": "#0c9560",
        "منطقة المدينة المنورة": "#BEAD9D", "منطقة الشرقية": "#DBD1C5",
        "منطقة عسير": "#737476", "منطقة تبوك": "#293242",
        "منطقة الحدود الشمالية": "#BEAD9D", "منطقة الجوف": "#0c9560",
        "منطقة جازان": "#621d52", "منطقة نجران": "#21445B",
        "منطقة الباحة": "#323050", "منطقة القصيم": "#21445B",
        "منطقة حائل": "#621d52"
      };
    }

    function initSaudiMap() {
      const mapContainer = document.getElementById("map");
      const width = mapContainer.clientWidth;
      const height = Math.min(window.innerHeight * 0.8, 800);
      svg = d3.select("#map").append("svg")
        .attr("width", "100%").attr("height", height);
      projection = d3.geoMercator().center([44.5, 23]).scale(width * 1.1).translate([width / 2, height / 2]);
      const path = d3.geoPath().projection(projection);
      tooltip = d3.select("body").append("div").attr("class", "map-tooltip").style("visibility", "hidden");
      d3.json("https://raw.githubusercontent.com/Lama-G/training/main/saudiMap.geojson").then(geojson => {
        geojson.features.forEach(f => {
          const c = f.geometry.coordinates;
          if (f.geometry.type === "Polygon") c.forEach(r => r.reverse());
          else if (f.geometry.type === "MultiPolygon") c.forEach(p => p.forEach(r => r.reverse()));
        });
        svg.selectAll(".region").data(geojson.features).enter().append("path")
          .attr("class", "region").attr("d", path)
          .attr("fill", d => getSaudiColors()[d.properties.name] || "#ccc")
          .attr("stroke", "#000")
          .on("mouseover", (e, d) => {
            d3.select(e.currentTarget).attr("stroke-width", 2);
            tooltip.style("visibility", "visible").html(`<strong>${d.properties.name}</strong>`)
              .style("left", e.pageX + 15 + "px").style("top", e.pageY - 20 + "px");
          })
          .on("mouseout", (e) => {
            d3.select(e.currentTarget).attr("stroke-width", 1);
            tooltip.style("visibility", "hidden");
          });
        svg.selectAll(".region-label")
          .data(geojson.features)
          .enter().append("text")
          .attr("class", "region-label")
          .attr("transform", d => `translate(${path.centroid(d)})`)
          .attr("text-anchor", "middle")
          
        plotAllPins();
      });
    }

    async function plotAllPins(filterPlaces = []) {
      const { data: places } = await supabase.from('المكان').select('اسم_المكان, lat, lon');
      svg.selectAll(".place-pin").remove();
      const toPlot = filterPlaces.length > 0 ? places.filter(p => filterPlaces.includes(p.اسم_المكان)) : places;
      allPins = toPlot.filter(p => p.lat && p.lon);
      svg.selectAll(".place-pin").data(allPins).enter().append("circle")
        .attr("class", "place-pin")
        .attr("r", 6).attr("fill", filterPlaces.length > 0 ? "orange" : "crimson")
        .attr("stroke", "#fff").attr("stroke-width", 1.5)
        .attr("transform", d => `translate(${projection([d.lon, d.lat])})`)
        .on("mouseover", (event, d) => {
          tooltip.style("visibility", "visible")
            .html(`<strong>${d.اسم_المكان}</strong>`)
            .style("left", event.pageX + 15 + "px")
            .style("top", event.pageY - 20 + "px");
        })
        .on("mouseout", () => tooltip.style("visibility", "hidden"));
    }

    document.querySelector('.filter-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const poet = document.getElementById('poet').value;
      const place = document.getElementById('place').value;
      const type = document.getElementById('type').value;
      const purpose = document.getElementById('purpose').value;
      let query = supabase.from('القصيدة').select(`نوع_الشعر, الغرض_الشعري, الشاعر:معرف_الشاعر (اسم_الشاعر), المكان:معرف_المكان (اسم_المكان)`);
      if (poet) query = query.eq('الشاعر.اسم_الشاعر', poet);
      if (place) query = query.eq('المكان.اسم_المكان', place);
      if (type) query = query.eq('نوع_الشعر', type);
      if (purpose) query = query.eq('الغرض_الشعري', purpose);
      const { data } = await query;
      const placesMatched = [...new Set(data.map(d => d.المكان?.اسم_المكان).filter(Boolean))];
      if (placesMatched.length === 0) {
        document.getElementById("alertBox").style.display = "block";
        plotAllPins([]);
      } else {
        plotAllPins(placesMatched);
        document.getElementById("alertBox").style.display = "none";
      }
    });

    function restoreAllPins() {
      document.getElementById("alertBox").style.display = "none";
      plotAllPins();
    }

    function resetFilters() {
      document.querySelectorAll(".filter-form select").forEach(select => select.value = "");
      document.getElementById("alertBox").style.display = "none";
    }

    fetchPoetsAndTypes();
    initSaudiMap();
  </script>
</body>
</html>
